// Use DBML to define your database structure
// Docs: https://dbml.dbdiagram.io/docs
// DB schema online: https://dbdiagram.io/home

Table users {
  id integer [primary key]
  username varchar
  email varchar
  role_id integer [ref: > roles.id]
  password_hash varchar
  avatar_url varchar
  bio varchar
  created_at timestamp
}

Table roles {
  id integer [primary key]
  name varchar
}

Table reviews {
  id integer [primary key]
  title varchar
  body varchar
  rating smallint 
  user_id integer [ref: > users.id]
  object_id integer [ref: > objects.id]
  date_of_visit date
  created_at timestamp
}

Table reviews_responses {
  id integer [primary key]
  review_id integer [ref: > reviews.id]
  user_id integer [ref: > users.id]
  body varchar
  created_at timestamp
}

Table reviews_photos {
  id integer [primary key]
  review_id integer [ref: > reviews.id]
  photo_url varchar
  created_at timestamp
}

Table objects {
  id integer [primary key]
  name varchar
  category_id integer [ref: > categories.id]
  location_id integer [ref: > locations.id]
  rating smallint // считается асинхронно, обновляется с некоторой периодичностью
  price integer
  currency enum
  website varchar
  description varchar
}

Table categories {
  id integer [primary key]
  name varchar [note: 'hotel, restaurant, attraction, ...']
}

Table objects_photos {
  id integer [primary key]
  object_id integer [ref: > objects.id]
  photo_url varchar
  created_at timestamp
}

Table trips {
  id integer [primary key]
  name varchar
  user_id integer [ref: > users.id]
  created_at timestamp
  updated_at timestamp
}

Table trips_objects {
  trip_id integer [ref: > trips.id]
  object_id integer [ref: > objects.id]
}

Table locations {
  id integer [primary key]
  country_id integer [ref: > countries.id]
  locality varchar  // город или населенный пункт
  street varchar  // улица и номер дома
  add_info varchar  // дополнительные сведения (при необходимости)
}

// вспомогательная таблица
Table countries {
  id integer [primary key]
  iso_code varchar(2)
  name varchar
}

Table sessions {
  id integer [primary key]
  user_id integer [ref: > users.id]
  session_token varchar
  created_at timestamp
  expires_at timestamp
}

Table metrics {
  id bigint [primary key]
  event_type varchar
  event_timestamp timestamp
  metadata text
}

Table logs {
  id bigint [primary key]
  log_level varchar
  message text
  created_at timestamp
}

Table images {
  object_files varchar
  avatar_files varchar
}

Table recommendations {
  id integer [primary key]
  user_id integer [ref: > users.id]
  recommendations text
  created_at timestamp
}

Table object_search_cache {
  id integer [primary key]
  query_hash varchar
  result text
  expires_at timestamp
}

Table object_search {
  id integer [primary key]
  object_id integer [ref: > objects.id]
  name varchar
  description text
  location varchar
  category varchar
  rating float
  price integer
  currency varchar
}
